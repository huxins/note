# 树结构

## 二叉搜索树

二叉搜索树 (Binary search tree) 具有以下性质：

- 若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值；
- 若任意节点的右子树不空，则右子树上所有节点的值均大于它的根节点的值；
- 任意节点的左、右子树也分别为二叉查找树；

一般的二叉查找树的查询复杂度取决于目标结点到树根的距离，因此当结点的深度普遍较大时，查询的均摊复杂度会上升。为了实现更高效的查询，产生了**平衡树**。在这里，平衡指所有叶子的深度趋于平衡，更广义的是指在树上所有可能查找的均摊复杂度偏低。

## 平衡树

自平衡二叉搜索树在符合二叉搜索树的条件下，所有叶子的深度趋于平衡。

## B-tree

B-tree 是为磁盘等存储设备设计的一种平衡查找树，系统从磁盘读取数据到内存时是以磁盘块为基本单位，位于同一个磁盘块中的数据会被一次性读取出来，所以在查询数据时如果一个磁盘块中的每条数据都能有助于定位数据记录的位置，这将会减少磁盘 I/O 次数，提高查询效率。

为了描述 B-tree，定义一条记录为一个二元组 [key, data]，key 为记录的键值，对应表中的主键值，data 为一行记录中除主键外的数据。对于不同的记录，key 值互不相同。

一个 *m* 阶的 B-tree 是一个有以下属性的树：

- 每一个节点最多有 *m* 个子节点
- 一个非叶子节点（除根节点）最少有 ⌈*m/2*⌉ 个子节点
- 如果根节点不是叶子节点，那么它至少有两个子节点
- 有 *k* 个子节点的非叶子节点拥有 *k − 1* 个键
- 所有的叶子节点都在同一层

B-tree 中的每个节点根据实际情况可以包含大量的关键字信息和分支，如下图所示为一个 3 阶的 B-tree：

![B-tree](https://img.inxiny.cn/manual/b-tree.png)

每个节点占用一个磁盘块，一个节点上有两个升序排序的关键字和三个指向子树根节点的指针，指针存储的是子节点所在磁盘块的地址。两个关键词划分成的三个范围域对应三个指针指向的子树的数据的范围域。以根节点为例，关键字为 17 和 35，P1 指针指向的子树的数据范围为小于 17，P2 指针指向的子树的数据范围为 17~35，P3 指针指向的子树的数据范围为大于 35。

B-tree 相对于 AVL tree 缩减了节点个数，使每次磁盘 I/O 取到内存的数据都发挥了作用，从而提高了查询效率。

## B+ tree

B+ tree 是在 B-tree 基础上的一种优化，使其更适合实现外存储索引结构，InnoDB 存储引擎就是用 B+ tree 实现其索引结构。

从 B-tree 结构图中可以看到每个节点中不仅包含数据的 key 值，还有 data 值。而每一个页的存储空间是有限的，如果 data 数据较大时将会导致每个节点能存储的 key 的数量很小，当存储的数据量很大时同样会导致 B-tree 的深度较大，增大查询时的磁盘 I/O 次数，进而影响查询效率。在 B+ tree 中，所有数据记录节点都是按照键值大小顺序存放在同一层的叶子节点上，而非叶子节点上只存储 key 值信息，这样可以大大增加每个节点存储的 key 值数量，降低 B+ tree 的高度。

B+ tree 相对于 B-tree 有几点不同：

- 非叶子节点只存储键值信息
- 所有叶子节点之间都有一个链指针
- 数据记录都存放在叶子节点中

将 B-tree 优化，由于 B+ tree 的非叶子节点只存储键值信息，假设每个磁盘块能存储 4 个键值及指针信息，则变成 B+ tree 后其结构如下图所示：

![B+tree](https://img.inxiny.cn/manual/b+tree.png)

通常在 B+ tree 上有两个头指针，一个指向根节点，另一个指向关键字最小的叶子节点，而且所有叶子节点之间是一种链式环结构。因此可以对 B+ tree 进行两种查找运算：一种是对于主键的范围查找和分页查找，另一种是从根节点开始，进行随机查找。

InnoDB 存储引擎中页的大小为 16 KB，一般表的主键类型为 INT 或 BIGINT，指针类型也一般为 4 或 8 个字节，也就是说一个页中大概存储 16KB/(8B+8B) ≈ 1K 个键值。也就是说一个深度为 3 的 B+ tree 索引可以维护 10<sup>3</sup> * 10<sup>3</sup> * 10<sup>3</sup> = 10 亿条记录。

数据库中的 B+ tree 索引可以分为聚集索引 (Clustered) 和辅助索引 (Secondary)。上面的 B+ tree 示例图在数据库中的实现即为聚集索引，聚集索引的 B+ tree 中的叶子节点存放的是整张表的行记录数据。辅助索引与聚集索引的区别在于辅助索引的叶子节点并不包含行记录的全部数据，而是存储相应行数据的聚集索引键，即主键。当通过辅助索引来查询数据时，InnoDB 存储引擎会遍历辅助索引找到主键，然后再通过主键在聚集索引中找到完整的行记录数据。

