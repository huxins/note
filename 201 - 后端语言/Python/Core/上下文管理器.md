# 上下文管理器

### 上下文管理器类型

Python 的 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句支持由[上下文管理器](https://docs.python.org/zh-cn/3/library/stdtypes.html#context-manager-types)定义的运行时上下文这一概念。

此对象的实现使用了一对专门方法，允许用户自定义类来定义运行时上下文，在语句体被执行前进入该上下文，并在语句执行完毕时退出该上下文。

- contextmanager.**\__enter__**()

  进入运行时上下文并返回此对象或关联到该运行时上下文的其他对象。

  此方法的返回值会绑定到使用此上下文管理器的 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句的 `as` 子句中的标识符。

  - 一个返回其自身的上下文管理器的例子是 *file object*。

    文件对象会从 [`__enter__()`](https://docs.python.org/zh-cn/3/library/stdtypes.html#contextmanager.__enter__) 返回其自身，以允许 [`open()`](https://docs.python.org/zh-cn/3/library/functions.html#open) 被用作 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句中的上下文表达式。

  - 一个返回关联对象的上下文管理器的例子是 [`decimal.localcontext()`](https://docs.python.org/zh-cn/3/library/decimal.html#decimal.localcontext) 所返回的对象。

    此种管理器会将活动的 [`decimal`](https://docs.python.org/zh-cn/3/library/decimal.html) 上下文设为原始 [`decimal`](https://docs.python.org/zh-cn/3/library/decimal.html) 上下文的一个副本并返回该副本。这允许对 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句的语句体中的当前 [`decimal`](https://docs.python.org/zh-cn/3/library/decimal.html) 上下文进行更改，而不会影响 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句以外的代码。

- contextmanager.**\__exit__**(*exc_type*, *exc_val*, *exc_tb*)

  退出运行时上下文并返回一个布尔值标识来表明所发生的任何异常是否应当被屏蔽。

  如果在执行 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句的语句体期间发生了异常，则参数会包含异常的类型、值以及回溯信息。在其他情况下三个参数均为 `None`。

Python 定义了一些上下文管理器来支持简易的线程同步、文件或其他对象的快速关闭，以及更方便地操作活动的 `decimal` 上下文。

除了实现上下文管理协议以外，不同类型不会被特殊处理。




- **上下文管理器**

  [上下文管理器](https://docs.python.org/zh-cn/3.10/library/stdtypes.html#context-manager-types)定义了在执行 `with` 语句时要建立的运行时上下文。[上下文管理器](https://docs.python.org/zh-cn/3/reference/datamodel.html#with-statement-context-managers)处理进入和退出所需运行时上下文，以执行代码块。

  上下文管理器的典型用法包括保存和恢复各种全局状态，锁定和解锁资源，关闭打开的文件等等。

  - object.[**\__enter__**](https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__enter__)()

    进入与此对象相关的运行时上下文。`with` 语句将会绑定这个方法的返回值到 `as` 子句中指定的目标，如果有的话。

  - object.[**\__exit__**](https://docs.python.org/zh-cn/3/reference/datamodel.html#object.__exit__)()

    退出关联到此对象的运行时上下文。





### with

[`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#the-with-statement) 语句用于包装带有使用[上下文管理器](https://docs.python.org/zh-cn/3/reference/datamodel.html#context-managers)定义的方法的代码块的执行。这允许对普通的 [`try`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#try)...[`except`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#except)...[`finally`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#finally) 使用模式进行封装以方便地重用。

[`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#with) 语句的执行过程如下：

```
1、对上下文表达式进行求值来获得上下文管理器。
2、载入上下文管理器的 __enter__() 以便后续使用。
3、载入上下文管理器的 __exit__() 以便后续使用。
4、发起调用上下文管理器的 __enter__() 方法。
5、如果 with 语句中包含一个目标，来自 __enter__() 的返回值将被赋值给它。
6、执行语句体。
7、发起调用上下文管理器的 __exit__() 方法。
    如果语句体的退出是由异常导致的，则其类型、值和回溯信息将被作为参数传递给 __exit__()。否则的话，将提供三个 None 参数。
    如果语句体的退出是由异常导致的，并且来自 __exit__() 方法的返回值为假，则该异常会被重新引发。如果返回值为真，则该异常会被抑制，并会继续执行 with 语句之后的语句。
    如果语句体由于异常以外的任何原因退出，则来自 __exit__() 的返回值会被忽略，并会在该类退出正常的发生位置继续执行。
```

以下代码：

```python
with EXPRESSION as TARGET:
    SUITE
```

在语义上等价于：

```python
manager = (EXPRESSION)
enter = type(manager).__enter__
exit = type(manager).__exit__
value = enter(manager)
hit_except = False

try:
    TARGET = value
    SUITE
except:
    hit_except = True
    if not exit(manager, *sys.exc_info()):
        raise
finally:
    if not hit_except:
        exit(manager, None, None, None)
```

如果有多个项目，则会视作存在多个 [`with`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#with) 语句嵌套来处理多个上下文管理器：

```python
with A() as a, B() as b:
    SUITE
```

在语义上等价于：

```python
with A() as a:
    with B() as b:
        SUITE
```

也可以用圆括号包围的多行形式的多项目上下文管理器：

```python
with (
    A() as a,
    B() as b,
):
    SUITE
```


