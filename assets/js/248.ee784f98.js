(window.webpackJsonp=window.webpackJsonp||[]).push([[248],{562:function(s,a,t){"use strict";t.r(a);var e=t(27),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"dnsmasq"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dnsmasq"}},[s._v("#")]),s._v(" Dnsmasq")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://thekelleys.org.uk/dnsmasq/doc.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Dnsmasq"),a("OutboundLink")],1),s._v(" 是一个轻量级的 DNS 缓存服务器，同时也支持 DHCP、TFTP 和 PXE 相关功能。它特别适用于小型网络（如家庭、办公室或嵌入式设备）中提供高效的本地 DNS 解析和 IP 地址管理。")]),s._v(" "),a("p",[s._v("当接受到一个 DNS 请求时，"),a("code",[s._v("dnsmasq")]),s._v(" 首先会查找 "),a("code",[s._v("/etc/hosts")]),s._v("，然后查找 "),a("code",[s._v("/etc/resolv.conf")]),s._v(" 中定义的外部 DNS。")]),s._v(" "),a("h2",{attrs:{id:"一、安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、安装"}},[s._v("#")]),s._v(" 一、安装")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("RHEL")])]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" dnsmasq\n")])])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("Debian")])]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" dnsmasq\nsystemctl status dnsmasq\n")])])])])]),s._v(" "),a("h2",{attrs:{id:"二、配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、配置文件"}},[s._v("#")]),s._v(" 二、配置文件")]),s._v(" "),a("p",[s._v("所有的配置都在一个文件中完成，默认是 "),a("code",[s._v("/etc/dnsmasq.conf")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("基本配置示例")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定上游 DNS 服务器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("8.8.8.8")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1.1.1.1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用本地 DNS 解析")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/local.lan/192.168.1.1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用 DHCP 服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("dhcp-range")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("192.168.1.100,192.168.1.200,12h")]),s._v("\n")])])]),a("p",[s._v("也可以通过命令行配置该文件。")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" /etc/dnsmasq.conf  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-Ev")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^#|^$"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" /etc/dnsmasq.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<-")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'EOF'\nlisten-address=127.0.0.1\nresolv-file=/etc/resolv.conf\nEOF")]),s._v("\n")])])]),a("p",[s._v("测试服务是否可用。")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nslookup")]),s._v(" example.com "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\n")])])]),a("h2",{attrs:{id:"三、配置项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、配置项"}},[s._v("#")]),s._v(" 三、配置项")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("-"),a("strong",[s._v("p")]),s._v(", --"),a("strong",[s._v("port")]),s._v("="),a("em",[s._v("port")]),s._v("：指定 DNS 端口，默认为 "),a("code",[s._v("53")]),s._v("。设置为零将完全禁用 DNS 功能，仅保留 DHCP。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("domain-needed")]),s._v("：不向上游转发格式错误的域名。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("bogus-priv")]),s._v("：不向上游转发私有 IP 反向查找。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("resolv-file")]),s._v("：指定上游 DNS 服务器文件，默认是 "),a("code",[s._v("/etc/resolv.conf")]),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("strict-order")]),s._v("：强制 "),a("code",[s._v("dnsmasq")]),s._v(" 严格按照 "),a("code",[s._v("/etc/resolv.conf")]),s._v(" 中出现的顺序对每个服务器尝试每个查询。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("no-resolv")]),s._v("：仅从命令行或 "),a("code",[s._v("dnsmasq")]),s._v(" 配置文件获取上游服务器。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("no-poll")]),s._v("：不要轮询 "),a("code",[s._v("/etc/resolv.conf")]),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("no-hosts")]),s._v("：不要读取 "),a("code",[s._v("/etc/hosts")]),s._v(" 中的主机名。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("addn-hosts")]),s._v("：附加主机文件。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("server")]),s._v("：直接指定上游服务器的 IP 地址。")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/fooxample.com/192.168.0.1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("208.67.222.222")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("208.67.222.222@eth1")]),s._v("\n")])])]),a("p",[s._v("设置一个反向解析，所有 192.168.3.0/24 的地址都到 10.1.2.3 去解析：")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/3.168.192.in-addr.arpa/10.1.2.3")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("local")]),s._v("：和 "),a("code",[s._v("--server")]),s._v(" 作用相似，可以回答来自 "),a("code",[s._v("/etc/hosts")]),s._v(" 或 DHCP 的查询，但不将该域上的查询转发到任何上游服务器。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("address")]),s._v("：指定要为给定域中的任何主机返回的 IP 地址。")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/mehxample.com/192.168.0.5")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("ipset")]),s._v("：将一个或多个域的查询解析的 IP 地址放在指定的 Netfilter IP 集中。")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("ipset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/yahoo.com/google.com/vpn,search")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("interface")]),s._v("：仅在指定的接口上侦听。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("listen-address")]),s._v("：仅在指定的 IP 上侦听。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("no-dhcp-interface")]),s._v("：不在指定接口上提供 DHCP，但提供 DNS 服务。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("expand-hosts")]),s._v("：将自定义域添加到 "),a("code",[s._v("/etc/hosts")]),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("domain")]),s._v("：指定 DHCP 服务器的 DNS 域。")])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("dhcp-range")]),s._v("：DHCP 分发 IP 的范围，以及每个 IP 的租约时间。")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("dhcp-range")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("192.168.0.50,192.168.0.150,12h")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("dhcp-range")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("192.168.0.50,192.168.0.150,255.255.255.0,12h")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("--"),a("strong",[s._v("cache-size")]),s._v("：设置 "),a("code",[s._v("dnsmasq")]),s._v(" 的缓存大小。")])])]),s._v(" "),a("h2",{attrs:{id:"reference"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[s._v("#")]),s._v(" Reference")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.hi-linux.com/posts/30947.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("利用 Dnsmasq 部署 DNS 服务 - "),a("em",[s._v("奇妙的 Linux 世界")]),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/felixonmars/dnsmasq-china-list",target:"_blank",rel:"noopener noreferrer"}},[s._v("dnsmasq-china-list - "),a("em",[s._v("GitHub")]),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.txt",target:"_blank",rel:"noopener noreferrer"}},[s._v("DHCP Parameters - "),a("em",[s._v("IANA")]),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);