(window.webpackJsonp=window.webpackJsonp||[]).push([[163],{475:function(e,t,r){"use strict";r.r(t);var n=r(27),a=Object(n.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"entity-framework-core"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#entity-framework-core"}},[e._v("#")]),e._v(" Entity Framework Core")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Entity Framework Core"),t("OutboundLink")],1),e._v(" 是轻量化、可扩展、开源和跨平台的数据访问技术。")]),e._v(" "),t("h2",{attrs:{id:"一、安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、安装"}},[e._v("#")]),e._v(" 一、安装")]),e._v(" "),t("p",[e._v("EF Core 以 "),t("a",{attrs:{href:"https://www.nuget.org/packages/Microsoft.EntityFrameworkCore",target:"_blank",rel:"noopener noreferrer"}},[e._v("NuGet 包"),t("OutboundLink")],1),e._v("的形式提供，支持多个"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/providers/",target:"_blank",rel:"noopener noreferrer"}},[e._v("数据库引擎"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("p",[e._v("MySQL 使用 "),t("a",{attrs:{href:"https://www.nuget.org/packages/Pomelo.EntityFrameworkCore.MySql",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("Pomelo.EntityFrameworkCore.MySql")]),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("dotnet "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" package Pomelo.EntityFrameworkCore.MySql "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--version")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("8.0")]),e._v(".2\n")])])]),t("h2",{attrs:{id:"二、模型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、模型"}},[e._v("#")]),e._v(" 二、模型")]),e._v(" "),t("p",[e._v("EF Core 使用元数据"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/",target:"_blank",rel:"noopener noreferrer"}},[e._v("模型"),t("OutboundLink")],1),e._v("来描述如何将应用程序的实体类型映射到基础数据库。")]),e._v(" "),t("h3",{attrs:{id:"实体类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实体类型"}},[e._v("#")]),e._v(" 实体类型")]),e._v(" "),t("p",[e._v("在上下文中包含一种类型的 "),t("code",[e._v("DbSet")]),e._v("，或在 "),t("code",[e._v("OnModelCreating")]),e._v(" 方法中指定实体类型，意味着它包含在 EF Core 的模型中，我们将此类类型称为"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/entity-types",target:"_blank",rel:"noopener noreferrer"}},[e._v("实体"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("p",[e._v("例如，"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/dbcontext-configuration/",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("DbContext")]),t("OutboundLink")],1),e._v(" 的 "),t("code",[e._v("DbSet")]),e._v(" 属性中公开的类型作为实体包含在模型中。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("public class ApplicationDbContext : DbContext\n{\n    public DbSet<SalesOrder> SalesOrders { get; set; }\n}\n")])])]),t("p",[e._v("例如，在 "),t("code",[e._v("OnModelCreating")]),e._v(" 方法中指定的实体类型包含在模型中。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("public class ApplicationDbContext : DbContext\n{\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\n    {\n        modelBuilder.Entity<SalesOrder>();\n    }\n}\n")])])]),t("h3",{attrs:{id:"配置模型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置模型"}},[e._v("#")]),e._v(" 配置模型")]),e._v(" "),t("p",[e._v("可在 "),t("code",[e._v("ApplicationDbContext")]),e._v(" 中重写 "),t("code",[e._v("OnModelCreating")]),e._v(" 方法，并使用 "),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/#use-fluent-api-to-configure-a-model",target:"_blank",rel:"noopener noreferrer"}},[e._v("Fluent API"),t("OutboundLink")],1),e._v(" 来配置模型。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('protected override void OnModelCreating(ModelBuilder modelBuilder)\n{\n    modelBuilder.Entity<SalesOrder>(entity =>\n    {\n        entity.ToTable("so");\n\n        entity.HasKey(e => e.SalesOrderNumber);\n\n        entity\n            .Property(e => e.SalesOrderNumber)\n            .HasColumnName("so")\n            .HasMaxLength(10);\n\n        entity\n            .Property(e => e.OrderDate)\n            .HasColumnName("entered");\n    });\n}\n')])])]),t("p",[e._v("为了减小 "),t("code",[e._v("OnModelCreating")]),e._v(" 方法的大小，可以将实体类型的所有配置提取到实现 "),t("code",[e._v("IEntityTypeConfiguration<TEntity>")]),e._v(" 的单独类中。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('public class SalesOrderEntityTypeConfiguration : IEntityTypeConfiguration<SalesOrder>\n{\n    public void Configure(EntityTypeBuilder<SalesOrder> builder)\n    {\n        builder.ToTable("so");\n\n        builder.HasKey(e => e.SalesOrderNumber);\n\n        builder\n            .Property(e => e.SalesOrderNumber)\n            .HasColumnName("so")\n            .HasMaxLength(10);\n\n        builder\n            .Property(e => e.OrderDate)\n            .HasColumnName("entered");\n    }\n}\n')])])]),t("p",[e._v("然后，只需从 "),t("code",[e._v("OnModelCreating")]),e._v(" 调用 "),t("code",[e._v("Configure")]),e._v(" 方法。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("protected override void OnModelCreating(ModelBuilder modelBuilder)\n{\n    new SalesOrderEntityTypeConfiguration().Configure(modelBuilder.Entity<SalesOrder>());\n}\n")])])]),t("h3",{attrs:{id:"配置连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置连接"}},[e._v("#")]),e._v(" 配置连接")]),e._v(" "),t("p",[e._v("可以按照常规的 .NET 方式构造 "),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/dbcontext-configuration/#simple-dbcontext-initialization-with-new",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("DbContext")]),t("OutboundLink")],1),e._v(" 实例。")]),e._v(" "),t("p",[e._v("例如，通过重写 "),t("code",[e._v("OnConfiguring")]),e._v(" 方法来执行配置。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n{\n    if (optionsBuilder.IsConfigured) return;\n\n    string connectionString = @"server=localhost;\n                                port=3307;\n                                user id=user;\n                                password=****;\n                                database=test";\n\n    optionsBuilder.UseMySql(connectionString,\n        new MySqlServerVersion(new Version(8, 0, 21)));\n}\n')])])]),t("p",[e._v("更工程化的方法的通过"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/dbcontext-configuration/#dbcontext-in-dependency-injection-for-aspnet-core",target:"_blank",rel:"noopener noreferrer"}},[e._v("依赖关系注入"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("h3",{attrs:{id:"关系导航"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关系导航"}},[e._v("#")]),e._v(" 关系导航")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/relationships",target:"_blank",rel:"noopener noreferrer"}},[e._v("关系"),t("OutboundLink")],1),e._v("定义两个实体之间的相关性。")]),e._v(" "),t("h4",{attrs:{id:"一对多"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一对多"}},[e._v("#")]),e._v(" 一对多")]),e._v(" "),t("p",[e._v("当单个实体与任意数量的其他实体关联时，将使用"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/relationships/one-to-many",target:"_blank",rel:"noopener noreferrer"}},[e._v("一对多"),t("OutboundLink")],1),e._v("关系。")]),e._v(" "),t("p",[e._v("配置实体之间的一对多关系时，可以选择在多端或一端进行配置，但通常只需要在一端进行配置即可。")]),e._v(" "),t("p",[e._v("例如，最简单的一对多关系，就是 "),t("code",[e._v("Blog")]),e._v(" 和 "),t("code",[e._v("Post")]),e._v("。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("public class Blog\n{\n    public int Id { get; set; }\n    public ICollection<Post> Posts { get; } = new List<Post>();\n}\n\npublic class Post\n{\n    public int Id { get; set; }\n    public int BlogId { get; set; }\n    public Blog Blog { get; set; } = null!;\n}\n")])])]),t("p",[e._v("在 "),t("code",[e._v("OnModelCreating")]),e._v(" 的 "),t("code",[e._v("Entity<Blog>")]),e._v(" 中进行配置。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('builder.ToTable("Blog");\nbuilder\n    .HasMany(e => e.Posts)\n    .WithOne(e => e.Blog)\n    .HasForeignKey(e => e.BlogId);\n')])])]),t("p",[e._v("在 "),t("code",[e._v("OnModelCreating")]),e._v(" 的 "),t("code",[e._v("Entity<Post>")]),e._v(" 中进行配置。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('builder.ToTable("Post");\nbuilder\n    .HasOne(e => e.Blog)\n    .WithMany(e => e.Posts)\n    .HasForeignKey(e => e.BlogId);\n')])])]),t("h4",{attrs:{id:"一对一"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一对一"}},[e._v("#")]),e._v(" 一对一")]),e._v(" "),t("p",[e._v("当一个实体与最多一个其他实体关联时，将使用"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/relationships/one-to-one",target:"_blank",rel:"noopener noreferrer"}},[e._v("一对一"),t("OutboundLink")],1),e._v("关系。")]),e._v(" "),t("p",[e._v("例如，最简单的一对一关系，就是 "),t("code",[e._v("Blog")]),e._v(" 和 "),t("code",[e._v("BlogHeader")]),e._v("。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("public class Blog\n{\n    public int Id { get; set; }\n    public BlogHeader? Header { get; set; }\n}\n\npublic class BlogHeader\n{\n    public int Id { get; set; }\n    public int BlogId { get; set; }\n    public Blog? Blog { get; set; }\n}\n")])])]),t("p",[e._v("一对多已经明确谁是主体，而对于一对一关系二者为一一对应关系，所以 EF Core 无法判断其主体，必须我们手动去指定。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('builder.ToTable("Blog");\nbuilder\n    .HasOne(e => e.Header)\n    .WithOne(e => e.Blog)\n    .HasForeignKey<BlogHeader>(e => e.BlogId);\n')])])]),t("h4",{attrs:{id:"多对多"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#多对多"}},[e._v("#")]),e._v(" 多对多")]),e._v(" "),t("p",[e._v("当一个实体类型的任意数量的实体与相同或另一个实体类型的任意数量的实体相关联时，将使用"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/modeling/relationships/many-to-many",target:"_blank",rel:"noopener noreferrer"}},[e._v("多对多"),t("OutboundLink")],1),e._v("关系。")]),e._v(" "),t("p",[e._v("例如，最简单的多对多关系，就是 "),t("code",[e._v("Product")]),e._v(" 和 "),t("code",[e._v("Category")]),e._v("。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("public class Product\n{\n    public int Id { get; set; }\n    public string Name { get; set; }\n\n    public IEnumerable<ProductCategory> ProductCategorys { get; set; }\n}\n\npublic class Category\n{\n    public int Id { get; set; }\n    public string Name { get; set; }\n\n    public IEnumerable<ProductCategory> ProductCategorys { get; set; }\n}\n")])])]),t("h5",{attrs:{id:"中间实体"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#中间实体"}},[e._v("#")]),e._v(" 中间实体")]),e._v(" "),t("p",[e._v("通过 "),t("code",[e._v("ProductCategory")]),e._v(" 关联表，将其转为一对多的关系。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("public class ProductCategory\n{\n    public int ProductId { get; set; }\n    public Product Product { get; set; }\n\n    public int CategoryId { get; set; }\n    public Category Category { get; set; }\n}\n")])])]),t("p",[e._v("最终我们通过 "),t("code",[e._v("ProductCategory")]),e._v(" 来进行映射。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('builder.ToTable("ProductCategory");\nbuilder\n    .HasOne(e => e.Product)\n    .WithMany(e => e.ProductCategorys)\n    .HasForeignKey(e => e.ProductId);\nbuilder\n    .HasOne(e => e.Category)\n    .WithMany(e => e.ProductCategorys)\n    .HasForeignKey(e => e.CategoryId);\n')])])]),t("h5",{attrs:{id:"内置支持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内置支持"}},[e._v("#")]),e._v(" 内置支持")]),e._v(" "),t("p",[e._v("EF Core 3.0 及以上版本支持自动管理多对多关系，不需要显式定义中间实体。")]),e._v(" "),t("p",[e._v("内置的多对多关系不支持在中间表中存储额外的数据，因为中间实体被 EF Core 隐藏。")]),e._v(" "),t("h2",{attrs:{id:"三、查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、查询"}},[e._v("#")]),e._v(" 三、查询")]),e._v(" "),t("p",[e._v("Entity Framework Core 使用语言集成查询 LINQ 来"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/querying/",target:"_blank",rel:"noopener noreferrer"}},[e._v("查询"),t("OutboundLink")],1),e._v("数据库中的数据。")]),e._v(" "),t("h3",{attrs:{id:"单表查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单表查询"}},[e._v("#")]),e._v(" 单表查询")]),e._v(" "),t("p",[e._v("加载所有数据。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("using (var context = new ApplicationDbContext())\n{\n    var salesOrders = context.SalesOrders.ToList();\n}\n")])])]),t("p",[e._v("筛选。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('using (var context = new ApplicationDbContext())\n{\n    var salesOrderItems = context.SalesOrderItems\n        .Where(s => s.SalesOrderNumber.Contains("S2401196"))\n        .ToList();\n}\n')])])]),t("h3",{attrs:{id:"关联数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关联数据"}},[e._v("#")]),e._v(" 关联数据")]),e._v(" "),t("p",[e._v("Entity Framework Core 允许在模型中使用导航属性来"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/querying/related-data/",target:"_blank",rel:"noopener noreferrer"}},[e._v("加载关联实体"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("h4",{attrs:{id:"预先加载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#预先加载"}},[e._v("#")]),e._v(" 预先加载")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/querying/related-data/eager",target:"_blank",rel:"noopener noreferrer"}},[e._v("预先加载"),t("OutboundLink")],1),e._v("表示从数据库中加载关联数据，作为初始查询的一部分。")]),e._v(" "),t("p",[e._v("可以使用 "),t("code",[e._v("Include")]),e._v(" 方法来指定要包含在查询结果中的关联数据。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("using (var context = new BloggingContext())\n{\n    var salesOrderItems = context.SalesOrderItems\n        .Include(soi => soi.SalesOrder)\n        .ToList();\n}\n")])])]),t("p",[e._v("使用 "),t("code",[e._v("ThenInclude")]),e._v(" 方法可以依循关系包含多个层级的关联数据。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('using (var context = new BloggingContext())\n{\n    var salesOrderItems = context.SalesOrderItems\n        .Include(soi => soi.PartSpecification)\n        .ThenInclude(ps => ps!.PartTracking)\n        .Where(s => s.SalesOrderNumber.Contains("S2401196"))\n        .ToList();\n}\n')])])]),t("h2",{attrs:{id:"四、保存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、保存"}},[e._v("#")]),e._v(" 四、保存")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/saving/",target:"_blank",rel:"noopener noreferrer"}},[e._v("保存"),t("OutboundLink")],1),e._v("数据意味着向数据库添加新实体、删除实体或以某种方式修改现有实体的属性。")]),e._v(" "),t("h3",{attrs:{id:"添加数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加数据"}},[e._v("#")]),e._v(" 添加数据")]),e._v(" "),t("p",[e._v("使用 "),t("code",[e._v("DbSet<TEntity>.Add")]),e._v(" 方法"),t("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/ef/core/saving/basic#adding-data",target:"_blank",rel:"noopener noreferrer"}},[e._v("添加"),t("OutboundLink")],1),e._v("实体类的新实例。调用 "),t("code",[e._v("DbContext.SaveChanges()")]),e._v(" 时，数据将插入到数据库中。")]),e._v(" "),t("div",{staticClass:"language-c# extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('using (var context = new BloggingContext())\n{\n    var blog = new Blog { Url = "http://example.com" };\n    context.Blogs.Add(blog);\n    context.SaveChanges();\n}\n')])])])])}),[],!1,null,null,null);t.default=a.exports}}]);